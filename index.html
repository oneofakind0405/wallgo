<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wall Go - ë²½ë°”ë‘‘</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .game-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 30px;
            max-width: 800px;
            width: 100%;
        }

        .game-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .game-title {
            font-size: 2.5em;
            color: #333;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .player-setup {
            text-align: center;
            margin: 20px 0;
        }

        .player-count-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .player-count-btn {
            padding: 15px 30px;
            font-size: 1.2em;
            font-weight: bold;
            border: 3px solid #ddd;
            background: white;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .player-count-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .player-count-btn.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .current-player {
            font-size: 1.2em;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 25px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            transition: background 0.3s ease;
        }
        .current-player.red { background: linear-gradient(45deg, #e74c3c, #c0392b); }
        .current-player.yellow { background: linear-gradient(45deg, #f1c40f, #f39c12); }
        .current-player.blue { background: linear-gradient(45deg, #3498db, #2980b9); }


        .timer {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            padding: 10px 20px;
            background: #f0f0f0;
            border-radius: 25px;
            border: 3px solid #ddd;
        }

        .timer.warning {
            background: #ffeb3b;
            border-color: #ff9800;
            animation: pulse 1s infinite;
        }

        .timer.danger {
            background: #f44336;
            color: white;
            border-color: #d32f2f;
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .walls-remaining {
            font-size: 1.1em;
            padding: 8px 16px;
            background: #e3f2fd;
            border-radius: 20px;
            border: 2px solid #2196f3;
        }

        .wall-break-container {
            text-align: center;
            margin: 10px 0;
        }

        .wall-break-btn {
            padding: 12px 24px;
            font-size: 1.1em;
            font-weight: bold;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .wall-break-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }

        .wall-break-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        .game-board {
            display: grid;
            grid-template-columns: repeat(7, 1fr); /* BOARD_SIZEë¡œ ë³€ê²½ ê°€ëŠ¥ */
            gap: 4px;
            background: #2c3e50;
            padding: 10px;
            border-radius: 15px;
            margin: 20px auto;
            max-width: 500px;
            aspect-ratio: 1;
        }

        .cell {
            background: #ecf0f1;
            border-radius: 8px;
            position: relative;
            aspect-ratio: 1;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .cell:hover {
            background: #d5dbdb;
            transform: scale(1.02);
        }

        .cell.selected {
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
        }
        .cell.highlight-possible-move { /* ì´ë™ ê°€ëŠ¥í•œ ì¹¸ í•˜ì´ë¼ì´íŠ¸ */
            background-color: #a5d6a7; /* ì—°ë…¹ìƒ‰ */
        }

        .piece {
            width: 70%;
            height: 70%;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            cursor: grab;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border: 3px solid rgba(255,255,255,0.3);
        }

        .piece:active {
            cursor: grabbing;
        }

        .piece.blinking {
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .piece.red {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .piece.yellow {
            background: linear-gradient(135deg, #f1c40f, #f39c12);
        }

        .piece.blue {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .wall {
            position: absolute;
            background: linear-gradient(45deg, #34495e, #2c3e50);
            border-radius: 2px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            z-index: 10; /* ë§ì´ ë²½ ìœ„ì— ë³´ì´ë„ë¡ */
        }

        .wall.top, .wall.bottom {
            width: 100%;
            height: 6px;
            left: 0;
        }

        .wall.top { top: -3px; }
        .wall.bottom { bottom: -3px; }

        .wall.left, .wall.right {
            width: 6px;
            height: 100%;
            top: 0;
        }

        .wall.left { left: -3px; }
        .wall.right { right: -3px; }

        .wall.red { background: linear-gradient(45deg, #e74c3c, #c0392b); }
        .wall.yellow { background: linear-gradient(45deg, #f1c40f, #f39c12); }
        .wall.blue { background: linear-gradient(45deg, #3498db, #2980b9); }

        .phase-indicator {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            font-size: 1em;
            font-weight: bold;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #11998e, #38ef7d);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .game-over {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .game-over-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            margin: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .scores {
            margin: 20px 0;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            border-radius: 10px;
            background: #f8f9fa;
        }

        @media (max-width: 600px) {
            .game-container {
                padding: 15px;
            }
            
            .game-title {
                font-size: 2em;
            }
            
            .game-info {
                flex-direction: column;
                gap: 10px;
            }
            
            .game-board {
                gap: 2px;
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <h1 class="game-title">ğŸ§± Wall Go</h1>
        </div>

        <div id="playerSetup" class="player-setup">
            <h2>í”Œë ˆì´ì–´ ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</h2>
            <div class="player-count-selector">
                <button class="player-count-btn" onclick="selectPlayerCount(2, event)">2ëª…</button>
                <button class="player-count-btn" onclick="selectPlayerCount(3, event)">3ëª…</button>
            </div>
            <button class="btn btn-primary" onclick="startGame()" style="margin-top: 20px;">ê²Œì„ ì‹œì‘</button>
        </div>

        <div id="gameArea" style="display: none;">
            <div class="phase-indicator" id="phaseIndicator">
                Phase 1: ì²« ë²ˆì§¸ ë§ ë°°ì¹˜
            </div>

            <div class="game-info">
                <div class="current-player" id="currentPlayer">Player 1</div>
                <div class="timer" id="timer">90</div>
                <div class="walls-remaining" id="wallsRemaining">ë²½ 25ê°œ ë‚¨ìŒ</div>
            </div>

            <div class="wall-break-container">
                <button class="wall-break-btn" id="wallBreakBtn" onclick="toggleWallBreakMode()">
                    ğŸ”¨ ë²½ ë¶€ìˆ˜ê¸° (1íšŒ)
                </button>
            </div>

            <div class="game-board" id="gameBoard"></div>

            <div class="controls">
                <button class="btn btn-secondary" onclick="resetGame()">ìƒˆ ê²Œì„</button>
                <button class="btn btn-primary" onclick="showRules()">ê²Œì„ ê·œì¹™</button>
            </div>
        </div>
    </div>

    <div id="gameOverModal" class="game-over" style="display: none;">
        <div class="game-over-content">
            <h2>ğŸ‰ ê²Œì„ ì¢…ë£Œ!</h2>
            <div class="scores" id="finalScores">
                </div>
            <button class="btn btn-primary" onclick="resetGame()">ìƒˆ ê²Œì„</button>
        </div>
    </div>

    <script>
    (function() { // IIFE ì‹œì‘
        // ê²Œì„ ìƒìˆ˜
        const BOARD_SIZE = 7;
        const INITIAL_TIME_LEFT = 90;
        const INITIAL_WALLS_PER_PLAYER = 25; // 2ì¸ ê¸°ì¤€, 3ì¸ì€ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ (ê·œì¹™ì— ë”°ë¼ ì¡°ì •)
        const PLAYER_COLORS = ['red', 'yellow', 'blue'];
        const PLAYER_NAMES = ['ë¹¨ê°•', 'ë…¸ë‘', 'íŒŒë‘'];

        // ê²Œì„ ìƒíƒœ ì „ì—­ ë³€ìˆ˜
        let gameState = {
            playerCount: 2,
            currentPlayer: 0,
            phase: 1, // 1: ì²« ë§ ë°°ì¹˜, 2: ë‘ ë²ˆì§¸ ë§ ë°°ì¹˜, 3: ê²Œì„ í”Œë ˆì´
            board: [],
            walls: [], // walls[row][col] = { top: playerIndex | null, bottom: ..., left: ..., right: ... }
            players: [], // { color, name, pieces: [{row, col}, {row, col}], wallsRemaining, wallBreakUsed }
            selectedPiece: null, // {row, col, pieceIndex}
            pieceMoved: false, // í˜„ì¬ í„´ì— ë§ì„ ì´ë™í–ˆëŠ”ì§€ ì—¬ë¶€
            timeLeft: INITIAL_TIME_LEFT,
            timer: null,
            wallBreakMode: false,
            gameStarted: false,
            placementOrder: [], // Phase 1 ë°°ì¹˜ ìˆœì„œ ê¸°ë¡
            reversePlacementIndex: 0 // Phase 2 ë°°ì¹˜ ìˆœì„œ ì¸ë±ìŠ¤
        };

        // í”Œë ˆì´ì–´ ìˆ˜ ì„ íƒ
        window.selectPlayerCount = function(count, event) {
            console.log('í”Œë ˆì´ì–´ ìˆ˜ ì„ íƒ:', count);
            gameState.playerCount = count;
            
            document.querySelectorAll('.player-count-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            if (event && event.target) {
                event.target.classList.add('selected');
            } else { // DOMContentLoadedì—ì„œ í˜¸ì¶œ ì‹œ eventê°€ ì—†ì„ ìˆ˜ ìˆìŒ
                const buttons = document.querySelectorAll('.player-count-btn');
                if (count === 2 && buttons[0]) buttons[0].classList.add('selected');
                else if (count === 3 && buttons[1]) buttons[1].classList.add('selected');
            }
        }

        // ê²Œì„ ì‹œì‘
        window.startGame = function() {
            console.log('ê²Œì„ ì‹œì‘ í•¨ìˆ˜ í˜¸ì¶œë¨');
            
            const selectedBtn = document.querySelector('.player-count-btn.selected');
            if (!selectedBtn) {
                alert('í”Œë ˆì´ì–´ ìˆ˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }

            console.log('í™”ë©´ ì „í™˜ ì¤‘...');
            document.getElementById('playerSetup').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';
            document.getElementById('gameOverModal').style.display = 'none';
            
            console.log('ê²Œì„ ì´ˆê¸°í™” ì¤‘...');
            initializeGame();
        }

        // ê²Œì„ ì´ˆê¸°í™”
        function initializeGame() {
            console.log('ê²Œì„ ì´ˆê¸°í™” ì‹œì‘');
            gameState.gameStarted = true;
            gameState.phase = 1;
            gameState.currentPlayer = 0;
            gameState.board = Array(BOARD_SIZE).fill(null).map(() => Array(BOARD_SIZE).fill(null));
            gameState.walls = Array(BOARD_SIZE).fill(null).map(() => Array(BOARD_SIZE).fill(null).map(() => ({
                top: null, bottom: null, left: null, right: null
            })));
            gameState.selectedPiece = null;
            gameState.pieceMoved = false;
            gameState.wallBreakMode = false;
            gameState.placementOrder = [];
            gameState.reversePlacementIndex = 0;

            // í”Œë ˆì´ì–´ ì´ˆê¸°í™”
            gameState.players = [];
            for (let i = 0; i < gameState.playerCount; i++) {
                gameState.players.push({
                    color: PLAYER_COLORS[i],
                    name: PLAYER_NAMES[i],
                    pieces: [{row: -1, col: -1}, {row: -1, col: -1}], // ì•„ì§ ë°°ì¹˜ë˜ì§€ ì•ŠìŒ
                    wallsRemaining: INITIAL_WALLS_PER_PLAYER, // í”Œë ˆì´ì–´ ìˆ˜ì— ë”°ë¼ ë²½ ê°œìˆ˜ ì¡°ì • í•„ìš” ì‹œ ì—¬ê¸°ì— ë¡œì§ ì¶”ê°€
                    wallBreakUsed: false
                });
            }

            createBoard();
            updateUI();
            startTimer();
            console.log('ê²Œì„ ì´ˆê¸°í™” ì™„ë£Œ. í˜„ì¬ í”Œë ˆì´ì–´:', gameState.players[gameState.currentPlayer].name);
        }

        // ë³´ë“œ ìƒì„±
        function createBoard() {
            const boardElement = document.getElementById('gameBoard');
            boardElement.innerHTML = '';
            boardElement.style.gridTemplateColumns = `repeat(${BOARD_SIZE}, 1fr)`;

            for (let row = 0; row < BOARD_SIZE; row++) {
                for (let col = 0; col < BOARD_SIZE; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    cell.addEventListener('click', function() {
                        handleCellClick(parseInt(this.dataset.row), parseInt(this.dataset.col), this);
                    });
                    
                    addWallPlacementEvents(cell); // ë²½ ë°°ì¹˜ ì´ë²¤íŠ¸ (í„°ì¹˜ìš©)
                    boardElement.appendChild(cell);
                }
            }
        }
        
        // ì…€ í´ë¦­ ì²˜ë¦¬
        function handleCellClick(row, col, cellElement) {
            console.log('ì…€ í´ë¦­:', row, col, 'í˜„ì¬ ë‹¨ê³„:', gameState.phase, 'ë§ ì´ë™ ì—¬ë¶€:', gameState.pieceMoved);

            if (gameState.wallBreakMode) {
                handleWallBreak(row, col); // ë²½ ë¶€ìˆ˜ê¸° ì‹œë„
                return;
            }

            if (gameState.phase <= 2) { // ë§ ë°°ì¹˜ ë‹¨ê³„
                placePieceDuringSetup(row, col);
            } else { // ê²Œì„ í”Œë ˆì´ ë‹¨ê³„
                if (gameState.selectedPiece) { // ì´ë¯¸ ì„ íƒëœ ë§ì´ ìˆì„ ë•Œ
                    if (gameState.selectedPiece.row === row && gameState.selectedPiece.col === col) {
                        // ì„ íƒëœ ë§ì„ ë‹¤ì‹œ í´ë¦­ (ë²½ ë°°ì¹˜ ì‹œë„ ë˜ëŠ” ì„ íƒ ì·¨ì†Œ)
                        if (gameState.pieceMoved) {
                             alert('ë²½ì„ ë°°ì¹˜í•˜ë ¤ë©´ ì´ë™í•œ ë§ì„ í„°ì¹˜ í›„ ìŠ¤ì™€ì´í”„í•˜ê±°ë‚˜, ë²½ ë°°ì¹˜ ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì„¸ìš”. (í˜„ì¬ í´ë¦­ìœ¼ë¡œëŠ” ë°©í–¥ ì§€ì • ë¶ˆê°€)');
                             // í–¥í›„ ê°œì„ : í´ë¦­ìœ¼ë¡œ ë²½ ë°©í–¥ ì„ íƒ UI ì œê³µ ë˜ëŠ” ê¸°ë³¸ ë°©í–¥ìœ¼ë¡œ ë°°ì¹˜
                        } else {
                            // ì„ íƒ ì·¨ì†Œ (ë˜ëŠ” ë‹¤ë¥¸ ì•¡ì…˜)
                            gameState.selectedPiece = null;
                            cellElement.classList.remove('selected');
                            removePossibleMoveHighlights();
                        }
                    } else {
                        movePiece(row, col); // ë‹¤ë¥¸ ì¹¸ í´ë¦­ ì‹œ ì´ë™ ì‹œë„
                    }
                } else { // ì„ íƒëœ ë§ì´ ì—†ì„ ë•Œ
                    selectPiece(row, col, cellElement); // ë§ ì„ íƒ ì‹œë„
                }
            }
        }

        // ë§ ë°°ì¹˜ (Phase 1 & 2)
        function placePieceDuringSetup(row, col) {
            if (gameState.board[row][col] !== null) {
                alert('ì´ë¯¸ ë§ì´ ìˆëŠ” ìœ„ì¹˜ì…ë‹ˆë‹¤!');
                return;
            }

            const currentPlayerObj = gameState.players[gameState.currentPlayer];
            const pieceIndex = gameState.phase === 1 ? 0 : 1; // ì²« ë²ˆì§¸ ë§ ë˜ëŠ” ë‘ ë²ˆì§¸ ë§

            // ì´ë¯¸ í•´ë‹¹ í”Œë ˆì´ì–´ê°€ ë§ì„ ê·¸ ìœ„ì¹˜ì— ë°°ì¹˜í–ˆëŠ”ì§€ í™•ì¸ (ì¤‘ë³µ ë°°ì¹˜ ë°©ì§€)
            if (currentPlayerObj.pieces[pieceIndex].row !== -1) {
                 // ì´ë¯¸ ì´ ë‹¨ê³„ì—ì„œ ë§ì„ ë†“ì•˜ë‹¤ë©´, ë‹¤ë¥¸ í”Œë ˆì´ì–´ í„´ì„ì—ë„ ë¶ˆêµ¬í•˜ê³  í´ë¦­ë˜ëŠ” ê²½ìš° ë°©ì§€
                if ( (gameState.phase === 1 && gameState.placementOrder.includes(gameState.currentPlayer) ) ||
                     (gameState.phase === 2 && gameState.players[gameState.placementOrder[gameState.reversePlacementIndex]].pieces[1].row !== -1 ) ) {
                    // console.log("ì´ë¯¸ ë§ì„ ë°°ì¹˜í–ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ í”Œë ˆì´ì–´ ì°¨ë¡€ì…ë‹ˆë‹¤.");
                    // return; // ì´ ë¶€ë¶„ì€ ì´ë¯¸ í„´ì´ ë„˜ì–´ê°”ì„ ê²ƒì´ë¯€ë¡œ ì‚¬ì‹¤ìƒ ë¶ˆí•„ìš”í•  ìˆ˜ ìˆìŒ
                }
            }


            gameState.board[row][col] = { player: gameState.currentPlayer, pieceIndex: pieceIndex };
            currentPlayerObj.pieces[pieceIndex] = {row, col};
            console.log(`${currentPlayerObj.name} í”Œë ˆì´ì–´, ${pieceIndex + 1}ë²ˆì§¸ ë§ (${row}, ${col})ì— ë°°ì¹˜`);

            if (gameState.phase === 1) {
                gameState.placementOrder.push(gameState.currentPlayer);
                gameState.currentPlayer = (gameState.currentPlayer + 1) % gameState.playerCount;
                
                if (gameState.placementOrder.length === gameState.playerCount) { // ëª¨ë“  í”Œë ˆì´ì–´ê°€ ì²« ë²ˆì§¸ ë§ì„ ë°°ì¹˜ ì™„ë£Œ
                    gameState.phase = 2;
                    gameState.reversePlacementIndex = gameState.playerCount - 1; // ë§ˆì§€ë§‰ í”Œë ˆì´ì–´ë¶€í„° ì‹œì‘
                    gameState.currentPlayer = gameState.placementOrder[gameState.reversePlacementIndex];
                    console.log("Phase 2 ì‹œì‘. í˜„ì¬ í”Œë ˆì´ì–´:", gameState.players[gameState.currentPlayer].name);
                }
            } else if (gameState.phase === 2) {
                gameState.reversePlacementIndex--;
                
                if (gameState.reversePlacementIndex >= 0) {
                    gameState.currentPlayer = gameState.placementOrder[gameState.reversePlacementIndex];
                    console.log("Phase 2 ì§„í–‰. í˜„ì¬ í”Œë ˆì´ì–´:", gameState.players[gameState.currentPlayer].name);
                } else { // ëª¨ë“  í”Œë ˆì´ì–´ê°€ ë‘ ë²ˆì§¸ ë§ì„ ë°°ì¹˜ ì™„ë£Œ
                    gameState.phase = 3;
                    gameState.currentPlayer = 0; // ì²« ë²ˆì§¸ í”Œë ˆì´ì–´ë¶€í„° ê²Œì„ ì‹œì‘
                    console.log("Phase 3 ì‹œì‘. í˜„ì¬ í”Œë ˆì´ì–´:", gameState.players[gameState.currentPlayer].name);
                }
            }

            updateBoard();
            updateUI();
            resetTimer();
        }

        function highlightPossibleMoves(fromRow, fromCol) {
            removePossibleMoveHighlights();
            const directions = [[0,1], [0,-1], [1,0], [-1,0], [0,2], [0,-2], [2,0], [-2,0]]; // 1ì¹¸, 2ì¹¸ ì´ë™

            for (const [dr, dc] of directions) {
                const toRow = fromRow + dr;
                const toCol = fromCol + dc;

                if (toRow >= 0 && toRow < BOARD_SIZE && toCol >= 0 && toCol < BOARD_SIZE) {
                    if (isValidMove(fromRow, fromCol, toRow, toCol)) {
                        const cell = document.querySelector(`.cell[data-row="${toRow}"][data-col="${toCol}"]`);
                        if (cell) {
                            cell.classList.add('highlight-possible-move');
                        }
                    }
                }
            }
        }

        function removePossibleMoveHighlights() {
            document.querySelectorAll('.cell.highlight-possible-move').forEach(cell => {
                cell.classList.remove('highlight-possible-move');
            });
        }


        // ë§ ì„ íƒ
        function selectPiece(row, col, cellElement) {
            const pieceData = gameState.board[row][col];
            if (!pieceData || pieceData.player !== gameState.currentPlayer) {
                console.log("ì„ íƒ ë¶ˆê°€: ìì‹ ì˜ ë§ì´ ì•„ë‹ˆê±°ë‚˜ ë¹ˆ ì¹¸ì…ë‹ˆë‹¤.");
                return;
            }
            if (gameState.pieceMoved) {
                alert("ì´ë¯¸ ë§ì„ ì›€ì§ì˜€ìŠµë‹ˆë‹¤. ë²½ì„ ë°°ì¹˜í•˜ê±°ë‚˜ í„´ì„ ë„˜ê¸°ì„¸ìš”.");
                return;
            }

            // ê¸°ì¡´ ì„ íƒëœ ì…€ ìŠ¤íƒ€ì¼ ì œê±°
            document.querySelectorAll('.cell.selected').forEach(cell => cell.classList.remove('selected'));

            gameState.selectedPiece = {row, col, pieceIndex: pieceData.pieceIndex};
            cellElement.classList.add('selected');
            console.log(`${gameState.players[pieceData.player].name}ì˜ ë§ (${row},${col}) ì„ íƒë¨`);
            highlightPossibleMoves(row, col);
        }

        // ë§ ì´ë™
        function movePiece(toRow, toCol) {
            if (!gameState.selectedPiece) return;
            if (gameState.pieceMoved) {
                alert("í•œ í„´ì— í•œ ë²ˆë§Œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                return;
            }

            const {row: fromRow, col: fromCol, pieceIndex} = gameState.selectedPiece;
            
            if (!isValidMove(fromRow, fromCol, toRow, toCol)) {
                alert('ì´ë™í•  ìˆ˜ ì—†ëŠ” ìœ„ì¹˜ì…ë‹ˆë‹¤! (ë‹¤ë¥¸ ë§ì´ ìˆê±°ë‚˜ ë²½ìœ¼ë¡œ ë§‰í˜€ìˆìŠµë‹ˆë‹¤)');
                return;
            }

            // ê¸°ì¡´ ìœ„ì¹˜ì˜ ë§ ì •ë³´ ì‚­ì œ
            gameState.board[fromRow][fromCol] = null;
            // ìƒˆ ìœ„ì¹˜ì— ë§ ì •ë³´ ì—…ë°ì´íŠ¸
            gameState.board[toRow][toCol] = { player: gameState.currentPlayer, pieceIndex: pieceIndex };
            // í”Œë ˆì´ì–´ ê°ì²´ì— ë§ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
            gameState.players[gameState.currentPlayer].pieces[pieceIndex] = {row: toRow, col: toCol};
            
            console.log(`${gameState.players[gameState.currentPlayer].name} ë§ (${fromRow},${fromCol}) -> (${toRow},${toCol}) ì´ë™`);
            
            gameState.selectedPiece = {row: toRow, col: toCol, pieceIndex: pieceIndex}; // ì„ íƒëœ ë§ ì •ë³´ ì—…ë°ì´íŠ¸ (ì´ë™í•œ ìœ„ì¹˜ë¡œ)
            gameState.pieceMoved = true;

            removePossibleMoveHighlights();
            updateBoard(); // ë³´ë“œ UI ì „ì²´ ì—…ë°ì´íŠ¸

            // ì´ë™í•œ ì…€ì— selected í´ë˜ìŠ¤ ë‹¤ì‹œ ì ìš©
            const newCellElement = document.querySelector(`.cell[data-row="${toRow}"][data-col="${toCol}"]`);
            if (newCellElement) {
                 // ì´ì „ selectedëŠ” updateBoard()ì—ì„œ ì§€ì›Œì§€ë¯€ë¡œ ë‹¤ì‹œ ì¶”ê°€.
                document.querySelectorAll('.cell.selected').forEach(cell => cell.classList.remove('selected'));
                newCellElement.classList.add('selected');
            }
            updateUI(); // ë‚¨ì€ ë²½ ê°œìˆ˜ ë“± ì—…ë°ì´íŠ¸
            // íƒ€ì´ë¨¸ëŠ” ë²½ ë°°ì¹˜ í›„ ë˜ëŠ” í„´ ì¢…ë£Œ ì‹œ ë¦¬ì…‹
        }

        // ì´ë™ ê°€ëŠ¥ì„± ê²€ì‚¬
        function isValidMove(fromRow, fromCol, toRow, toCol) {
            if (toRow < 0 || toRow >= BOARD_SIZE || toCol < 0 || toCol >= BOARD_SIZE) return false; // ë³´ë“œ ë²”ìœ„ ë°–
            if (gameState.board[toRow][toCol] !== null) return false; // ëª©ì ì§€ì— ë‹¤ë¥¸ ë§ì´ ìˆìŒ

            const dRow = toRow - fromRow;
            const dCol = toCol - fromCol;
            const absDRow = Math.abs(dRow);
            const absDCol = Math.abs(dCol);

            // 1ì¹¸ ì´ë™ (ìƒí•˜ì¢Œìš°)
            if ((absDRow === 1 && absDCol === 0) || (absDRow === 0 && absDCol === 1)) {
                // ë²½ í™•ì¸
                if (dRow === 1) return !gameState.walls[fromRow][fromCol].bottom && !gameState.walls[toRow][toCol].top; // ì•„ë˜ë¡œ
                if (dRow === -1) return !gameState.walls[fromRow][fromCol].top && !gameState.walls[toRow][toCol].bottom; // ìœ„ë¡œ
                if (dCol === 1) return !gameState.walls[fromRow][fromCol].right && !gameState.walls[toRow][toCol].left; // ì˜¤ë¥¸ìª½ìœ¼ë¡œ
                if (dCol === -1) return !gameState.walls[fromRow][fromCol].left && !gameState.walls[toRow][toCol].right; // ì™¼ìª½ìœ¼ë¡œ
                return true; // ì´ ë¶€ë¶„ì€ ì‚¬ì‹¤ìƒ ìœ„ ì¡°ê±´ë“¤ì—ì„œ ë‹¤ ê±¸ëŸ¬ì§
            }

            // 2ì¹¸ ì´ë™ (ìƒí•˜ì¢Œìš°)
            if ((absDRow === 2 && absDCol === 0) || (absDRow === 0 && absDCol === 2)) {
                const midRow = fromRow + dRow / 2;
                const midCol = fromCol + dCol / 2;

                // ì¤‘ê°„ ì¹¸ì— ë‹¤ë¥¸ ë§ì´ ì—†ì–´ì•¼ í•˜ê³ , ë²½ë„ ì—†ì–´ì•¼ í•¨
                if (gameState.board[midRow][midCol] !== null) return false;

                // ì²« ë²ˆì§¸ ìŠ¤í… ë²½ í™•ì¸
                if (dRow === 2) { // ì•„ë˜ë¡œ 2ì¹¸
                    if (gameState.walls[fromRow][fromCol].bottom || gameState.walls[midRow][midCol].top) return false;
                    if (gameState.walls[midRow][midCol].bottom || gameState.walls[toRow][toCol].top) return false;
                } else if (dRow === -2) { // ìœ„ë¡œ 2ì¹¸
                    if (gameState.walls[fromRow][fromCol].top || gameState.walls[midRow][midCol].bottom) return false;
                    if (gameState.walls[midRow][midCol].top || gameState.walls[toRow][toCol].bottom) return false;
                } else if (dCol === 2) { // ì˜¤ë¥¸ìª½ìœ¼ë¡œ 2ì¹¸
                    if (gameState.walls[fromRow][fromCol].right || gameState.walls[midRow][midCol].left) return false;
                    if (gameState.walls[midRow][midCol].right || gameState.walls[toRow][toCol].left) return false;
                } else if (dCol === -2) { // ì™¼ìª½ìœ¼ë¡œ 2ì¹¸
                    if (gameState.walls[fromRow][fromCol].left || gameState.walls[midRow][midCol].right) return false;
                    if (gameState.walls[midRow][midCol].left || gameState.walls[toRow][toCol].right) return false;
                }
                return true;
            }
            return false; // ê·¸ ì™¸ì˜ ì´ë™ì€ ë¶ˆê°€
        }
        
        // ë²½ ë¶€ìˆ˜ê¸° ëª¨ë“œ í† ê¸€
        window.toggleWallBreakMode = function() {
            const currentPlayerObj = gameState.players[gameState.currentPlayer];
            if (currentPlayerObj.wallBreakUsed && !gameState.wallBreakMode) { // ì´ë¯¸ ì‚¬ìš©í–ˆê³ , í˜„ì¬ ë¹„í™œì„±í™” ìƒíƒœë©´ ë” ì´ìƒ ëª» ì¼¬
                alert('ë²½ ë¶€ìˆ˜ê¸°ëŠ” ê²Œì„ë‹¹ 1íšŒë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!');
                return;
            }
             if (gameState.phase < 3) {
                alert('ë§ ë°°ì¹˜ê°€ ì™„ë£Œëœ í›„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            if (gameState.pieceMoved) {
                alert('ë§ì„ ì›€ì§ì¸ í›„ì—ëŠ” ë²½ ë¶€ìˆ˜ê¸°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ìŒ í„´ì— ì‹œë„í•˜ì„¸ìš”.');
                return;
            }


            gameState.wallBreakMode = !gameState.wallBreakMode;
            if (gameState.wallBreakMode) {
                gameState.selectedPiece = null; // ë§ ì„ íƒ í•´ì œ
                document.querySelectorAll('.cell.selected').forEach(cell => cell.classList.remove('selected'));
                removePossibleMoveHighlights();
                alert('ë²½ ë¶€ìˆ˜ê¸° ëª¨ë“œ í™œì„±í™”! ë¶€ìˆ  ë²½ì´ ìˆëŠ” ì¹¸ì„ ì„ íƒí•˜ì„¸ìš”.');
            } else {
                alert('ë²½ ë¶€ìˆ˜ê¸° ëª¨ë“œ ë¹„í™œì„±í™”.');
            }
            updateUI();
        }

        // ë²½ ë¶€ìˆ˜ê¸° ì²˜ë¦¬
        function handleWallBreak(row, col) {
            if (!gameState.wallBreakMode) return;
            
            // TODO: ì‹¤ì œ ë²½ ë¶€ìˆ˜ê¸° ë¡œì§ êµ¬í˜„ í•„ìš”
            // ì˜ˆ: ì–´ë–¤ ë²½ì„ ë¶€ìˆ ì§€ ì„ íƒí•˜ëŠ” UI (ìƒí•˜ì¢Œìš°) ë˜ëŠ” ìë™ìœ¼ë¡œ ê°€ì¥ ìµœê·¼ ë²½ ë“±
            // í˜„ì¬ëŠ” ì–´ë–¤ ë²½ì´ë“  í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ë¶€ì‰ˆë‹¤ê³  ê°€ì •í•˜ê³  í„´ ë„˜ê¹€ (ì„ì‹œ)
            let wallBroken = false;
            const cellWalls = gameState.walls[row][col];
            for (const dir in cellWalls) {
                if (cellWalls[dir] !== null) {
                    cellWalls[dir] = null; // í•´ë‹¹ ë°©í–¥ ë²½ ì œê±°
                    // ì¸ì ‘ ì…€ì˜ ëŒ€ì‘ ë²½ë„ ì œê±°í•´ì•¼ í•¨
                    if (dir === 'top' && row > 0) gameState.walls[row-1][col].bottom = null;
                    else if (dir === 'bottom' && row < BOARD_SIZE - 1) gameState.walls[row+1][col].top = null;
                    else if (dir === 'left' && col > 0) gameState.walls[row][col-1].right = null;
                    else if (dir === 'right' && col < BOARD_SIZE - 1) gameState.walls[row][col+1].left = null;
                    wallBroken = true;
                    break; 
                }
            }
            // ì¸ì ‘ ì…€ ê¸°ì¤€ìœ¼ë¡œë„ í™•ì¸ (ë²½ì€ ë‘ ì…€ì— ê±¸ì³ ìˆìœ¼ë¯€ë¡œ)
            if (!wallBroken && row > 0 && gameState.walls[row-1][col].bottom !== null) { // ìœ„ìª½ ì…€ì˜ ì•„ë˜ìª½ ë²½
                gameState.walls[row-1][col].bottom = null; gameState.walls[row][col].top = null; wallBroken = true;
            } else if (!wallBroken && row < BOARD_SIZE - 1 && gameState.walls[row+1][col].top !== null) { // ì•„ë˜ìª½ ì…€ì˜ ìœ„ìª½ ë²½
                gameState.walls[row+1][col].top = null; gameState.walls[row][col].bottom = null; wallBroken = true;
            } else if (!wallBroken && col > 0 && gameState.walls[row][col-1].right !== null) { // ì™¼ìª½ ì…€ì˜ ì˜¤ë¥¸ìª½ ë²½
                 gameState.walls[row][col-1].right = null; gameState.walls[row][col].left = null; wallBroken = true;
            } else if (!wallBroken && col < BOARD_SIZE - 1 && gameState.walls[row][col+1].left !== null) { // ì˜¤ë¥¸ìª½ ì…€ì˜ ì™¼ìª½ ë²½
                 gameState.walls[row][col+1].left = null; gameState.walls[row][col].right = null; wallBroken = true;
            }


            if (wallBroken) {
                alert(`(${row}, ${col}) ê·¼ì²˜ì˜ ë²½ì„ ë¶€ì‰ˆìŠµë‹ˆë‹¤!`);
                gameState.players[gameState.currentPlayer].wallBreakUsed = true;
                gameState.wallBreakMode = false; // ëª¨ë“œ ìë™ ë¹„í™œì„±í™”
                updateBoard();
                endTurn(); // ë²½ ë¶€ìˆ˜ê¸°ê°€ í•˜ë‚˜ì˜ í–‰ë™ìœ¼ë¡œ í„´ ì†Œëª¨
            } else {
                alert(`(${row}, ${col}) ì£¼ë³€ì— ë¶€ìˆ  ìˆ˜ ìˆëŠ” ë²½ì´ ì—†ìŠµë‹ˆë‹¤.`);
            }
        }

        // í„´ ì¢…ë£Œ
        function endTurn() {
            console.log("í„´ ì¢…ë£Œ:", gameState.players[gameState.currentPlayer].name);
            gameState.pieceMoved = false;
            gameState.wallBreakMode = false; // í„´ ì¢…ë£Œ ì‹œ ë²½ ë¶€ìˆ˜ê¸° ëª¨ë“œ í•´ì œ
            gameState.selectedPiece = null;
            
            document.querySelectorAll('.cell.selected').forEach(cell => cell.classList.remove('selected'));
            removePossibleMoveHighlights();

            gameState.currentPlayer = (gameState.currentPlayer + 1) % gameState.playerCount;
            console.log("ë‹¤ìŒ í”Œë ˆì´ì–´:", gameState.players[gameState.currentPlayer].name);
            
            // TODO: ê²Œì„ ì¢…ë£Œ ì¡°ê±´ í™•ì¸ (ì˜ˆ: ëª¨ë“  í”Œë ˆì´ì–´ê°€ ì›€ì§ì¼ ìˆ˜ ì—†ê±°ë‚˜, íŠ¹ì • ì ìˆ˜ ë„ë‹¬ ë“±)
            // if (checkGameOver()) {
            //     handleGameOver();
            //     return;
            // }

            updateUI();
            resetTimer();
        }

        // íƒ€ì´ë¨¸ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function startTimer() {
            clearInterval(gameState.timer);
            gameState.timeLeft = INITIAL_TIME_LEFT;
            updateTimerDisplay(); // ì¦‰ì‹œ ì‹œê°„ í‘œì‹œ ì—…ë°ì´íŠ¸
            gameState.timer = setInterval(() => {
                gameState.timeLeft--;
                updateTimerDisplay();
                
                if (gameState.timeLeft <= 0) {
                    handleTimeOut();
                }
            }, 1000);
        }

        function resetTimer() {
            // startTimer(); // startTimerê°€ clearIntervalì„ ì´ë¯¸ í˜¸ì¶œí•¨
            clearInterval(gameState.timer);
            gameState.timeLeft = INITIAL_TIME_LEFT;
            updateTimerDisplay();
            startTimer();
        }

        function updateTimerDisplay() {
            const timerElement = document.getElementById('timer');
            if (!timerElement) return;
            timerElement.textContent = gameState.timeLeft;
            
            timerElement.classList.remove('warning', 'danger');
            if (gameState.timeLeft <= 10) {
                timerElement.classList.add('danger');
            } else if (gameState.timeLeft <= 30) {
                timerElement.classList.add('warning');
            }
        }

        function handleTimeOut() {
            clearInterval(gameState.timer);
            alert(`${gameState.players[gameState.currentPlayer].name} í”Œë ˆì´ì–´ ì‹œê°„ ì´ˆê³¼! ë‹¤ìŒ í”Œë ˆì´ì–´ í„´ì…ë‹ˆë‹¤.`);
            endTurn();
        }

        // UI ì—…ë°ì´íŠ¸
        function updateUI() {
            if (!gameState.gameStarted) return; // ê²Œì„ ì‹œì‘ ì „ì—ëŠ” UI ì—…ë°ì´íŠ¸ ì•ˆ í•¨

            const currentPlayerElement = document.getElementById('currentPlayer');
            const wallsRemainingElement = document.getElementById('wallsRemaining');
            const wallBreakBtn = document.getElementById('wallBreakBtn');
            const phaseIndicator = document.getElementById('phaseIndicator');

            if (gameState.phase <= 2) {
                phaseIndicator.textContent = gameState.phase === 1 ? 
                    'Phase 1: ì²« ë²ˆì§¸ ë§ ë°°ì¹˜' : 'Phase 2: ë‘ ë²ˆì§¸ ë§ ë°°ì¹˜';
            } else {
                phaseIndicator.textContent = 'Phase 3: ê²Œì„ í”Œë ˆì´';
            }

            const currentPlayerObj = gameState.players[gameState.currentPlayer];
            currentPlayerElement.textContent = `${currentPlayerObj.name} (${currentPlayerObj.color}) í”Œë ˆì´ì–´`;
            
            // í”Œë ˆì´ì–´ ìƒ‰ìƒ í´ë˜ìŠ¤ ì„¤ì •
            PLAYER_COLORS.forEach(color => currentPlayerElement.classList.remove(color));
            currentPlayerElement.classList.add(currentPlayerObj.color);

            wallsRemainingElement.textContent = `ë²½ ${currentPlayerObj.wallsRemaining}ê°œ ë‚¨ìŒ`;

            if (gameState.phase === 3) {
                wallBreakBtn.style.display = 'inline-block';
                wallBreakBtn.disabled = currentPlayerObj.wallBreakUsed || gameState.pieceMoved; // ì‚¬ìš©í–ˆê±°ë‚˜, ë§ ì´ë™ í›„ì—ëŠ” ë¹„í™œì„±í™”
                
                let btnText = 'ğŸ”¨ ë²½ ë¶€ìˆ˜ê¸° (1íšŒ)';
                if (currentPlayerObj.wallBreakUsed) {
                    btnText = 'ğŸ”¨ ë²½ ë¶€ìˆ˜ê¸° (ì‚¬ìš©ì™„ë£Œ)';
                } else if (gameState.wallBreakMode) {
                    btnText = 'ğŸ”¨ ë²½ ë¶€ìˆ˜ê¸° (í™œì„±í™”)';
                }
                wallBreakBtn.textContent = btnText;

            } else {
                wallBreakBtn.style.display = 'none';
            }
            updateBlinkingPieces();
        }
        
        // ê¹œë¹¡ì´ëŠ” ë§ ì—…ë°ì´íŠ¸
        function updateBlinkingPieces() {
            document.querySelectorAll('.piece.blinking').forEach(p => p.classList.remove('blinking'));

            if (gameState.phase < 3 || !gameState.players[gameState.currentPlayer]) return;

            // í˜„ì¬ í„´ í”Œë ˆì´ì–´ì˜ ë§ë§Œ ê¹œë¹¡ì´ë„ë¡ (ì„ íƒë˜ì§€ ì•Šì•˜ì„ ë•Œ)
            if (!gameState.selectedPiece && !gameState.pieceMoved) {
                 gameState.players[gameState.currentPlayer].pieces.forEach(piecePos => {
                    if (piecePos.row !== -1) { // ë°°ì¹˜ëœ ë§ë§Œ
                        const cell = document.querySelector(`.cell[data-row="${piecePos.row}"][data-col="${piecePos.col}"]`);
                        const pieceElement = cell?.querySelector('.piece');
                        if (pieceElement) {
                            pieceElement.classList.add('blinking');
                        }
                    }
                });
            }
        }


        // ë³´ë“œ ì—…ë°ì´íŠ¸
        function updateBoard() {
            document.querySelectorAll('.cell').forEach(cellElement => {
                cellElement.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™” (ë§, ë²½)
                // cellElement.classList.remove('selected'); // ì„ íƒ í‘œì‹œëŠ” í´ë¦­ í•¸ë“¤ëŸ¬ì™€ ì´ë™ í•¨ìˆ˜ì—ì„œ ê´€ë¦¬

                const row = parseInt(cellElement.dataset.row);
                const col = parseInt(cellElement.dataset.col);
                
                // ë§ ë Œë”ë§
                const pieceData = gameState.board[row][col];
                if (pieceData !== null) {
                    const pieceElement = document.createElement('div');
                    pieceElement.className = `piece ${gameState.players[pieceData.player].color}`;
                    cellElement.appendChild(pieceElement);
                }

                // ë²½ ë Œë”ë§
                const wallsData = gameState.walls[row][col];
                Object.keys(wallsData).forEach(direction => { // top, bottom, left, right
                    if (wallsData[direction] !== null) { // ë²½ ì£¼ì¸ì˜ playerIndexê°€ ì €ì¥ë¨
                        const wallElement = document.createElement('div');
                        // ë²½ì˜ ìƒ‰ìƒì€ ì„¤ì¹˜í•œ í”Œë ˆì´ì–´ì˜ ìƒ‰ìƒì„ ë”°ë¥´ë„ë¡
                        wallElement.className = `wall ${direction} ${gameState.players[wallsData[direction]].color}`;
                        cellElement.appendChild(wallElement);
                    }
                });
            });
            updateBlinkingPieces(); // ë§ ê¹œë¹¡ì„ ì—…ë°ì´íŠ¸
             // ì„ íƒëœ ë§ ìˆìœ¼ë©´ ë‹¤ì‹œ selected í´ë˜ìŠ¤ ì¶”ê°€ (updateBoardê°€ ë‹¤ ì§€ìš°ë¯€ë¡œ)
            if (gameState.selectedPiece) {
                const selectedCell = document.querySelector(`.cell[data-row="${gameState.selectedPiece.row}"][data-col="${gameState.selectedPiece.col}"]`);
                if (selectedCell) selectedCell.classList.add('selected');
            }
        }

        // ê²Œì„ ë¦¬ì…‹
        window.resetGame = function() {
            clearInterval(gameState.timer);
            gameState.gameStarted = false; // ê²Œì„ ì¢…ë£Œ ìƒíƒœë¡œ ì„¤ì •

            document.getElementById('gameOverModal').style.display = 'none';
            document.getElementById('gameArea').style.display = 'none';
            document.getElementById('playerSetup').style.display = 'block';
            
            // í”Œë ˆì´ì–´ ìˆ˜ ì„ íƒ ë²„íŠ¼ ì´ˆê¸°í™”
            document.querySelectorAll('.player-count-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
             // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ê°’ìœ¼ë¡œ 2ëª… ì„ íƒëœ ê²ƒì²˜ëŸ¼ ì²˜ë¦¬
            const defaultPlayerCountButton = document.querySelector('.player-count-btn'); // ì²« ë²ˆì§¸ ë²„íŠ¼ (2ëª…)
            if (defaultPlayerCountButton) {
                defaultPlayerCountButton.classList.add('selected');
            }
            gameState.playerCount = 2; // gameStateë„ ì´ˆê¸°í™”
        }

        // ë²½ ë°°ì¹˜ë¥¼ ìœ„í•œ í„°ì¹˜ ì´ë²¤íŠ¸ ì²˜ë¦¬
        let touchStartPos = null; // {x, y, row, col}

        function addWallPlacementEvents(cell) {
            // í„°ì¹˜ ì´ë²¤íŠ¸
            cell.addEventListener('touchstart', handleTouchStart, {passive: false});
            cell.addEventListener('touchmove', handleTouchMove, {passive: false});
            cell.addEventListener('touchend', handleTouchEnd, {passive: false});
            // ë§ˆìš°ìŠ¤ ë“œë˜ê·¸ë¡œ ë²½ ë°°ì¹˜í•˜ëŠ” ê²ƒì€ í˜„ì¬ ë¯¸êµ¬í˜„. í•„ìš” ì‹œ ì¶”ê°€.
        }

        function handleTouchStart(e) {
            const cellElement = e.currentTarget;
            const row = parseInt(cellElement.dataset.row);
            const col = parseInt(cellElement.dataset.col);

            // ì¡°ê±´: ê²Œì„ í”Œë ˆì´ ë‹¨ê³„, ë§ì´ ì´ë¯¸ ì´ë™í–ˆê³ , í´ë¦­ëœ ì…€ì´ í˜„ì¬ ì„ íƒëœ(ì´ë™í•œ ë§ì´ ìˆëŠ”) ì…€ì´ì–´ì•¼ í•¨
            if (gameState.phase === 3 && gameState.pieceMoved && 
                gameState.selectedPiece && gameState.selectedPiece.row === row && gameState.selectedPiece.col === col) {
                
                touchStartPos = {
                    x: e.touches[0].clientX,
                    y: e.touches[0].clientY,
                    row: row,
                    col: col
                };
                // e.preventDefault(); // ìŠ¤í¬ë¡¤ ë°©ì§€ ë“±. í•„ìš”ì— ë”°ë¼.
            } else {
                touchStartPos = null;
            }
        }

        function handleTouchMove(e) {
            if (!touchStartPos) return;
            // e.preventDefault(); // ìŠ¤í¬ë¡¤ ë°©ì§€ ë“±.
        }

        function handleTouchEnd(e) {
            if (!touchStartPos) return;
            // e.preventDefault();

            const touchEndPos = {
                x: e.changedTouches[0].clientX,
                y: e.changedTouches[0].clientY
            };

            const deltaX = touchEndPos.x - touchStartPos.x;
            const deltaY = touchEndPos.y - touchStartPos.y;
            const threshold = 20; // ìŠ¤ì™€ì´í”„ ê°ì§€ ë¯¼ê°ë„

            let direction = null;
            if (Math.abs(deltaX) > threshold || Math.abs(deltaY) > threshold) {
                if (Math.abs(deltaX) > Math.abs(deltaY)) {
                    direction = deltaX > 0 ? 'right' : 'left';
                } else {
                    direction = deltaY > 0 ? 'bottom' : 'top';
                }
            }

            if (direction) {
                console.log(`ë²½ ë°°ì¹˜ ì‹œë„: (${touchStartPos.row}, ${touchStartPos.col})ì— ${direction} ë°©í–¥ìœ¼ë¡œ`);
                placeWallInDirection(touchStartPos.row, touchStartPos.col, direction);
            } else {
                // ìŠ¤ì™€ì´í”„ê°€ ì•„ë‹Œ ë‹¨ìˆœ íƒ­ìœ¼ë¡œ ê°„ì£¼ë  ìˆ˜ ìˆìŒ.
                // ì´ ê²½ìš° handleCellClickì—ì„œ ì´ë¯¸ ì²˜ë¦¬ë˜ì—ˆê±°ë‚˜, ì¶”ê°€ì ì¸ ì•¡ì…˜ ì •ì˜ ê°€ëŠ¥.
                console.log("ìŠ¤ì™€ì´í”„ ê°ì§€ ì•ˆë¨. ë‹¨ìˆœ íƒ­ìœ¼ë¡œ ê°„ì£¼.");
            }
            touchStartPos = null;
        }

        // íŠ¹ì • ë°©í–¥ìœ¼ë¡œ ë²½ ë°°ì¹˜
        function placeWallInDirection(row, col, direction) {
            if (!gameState.pieceMoved) {
                // ì´ í•¨ìˆ˜ëŠ” pieceMoved ì´í›„ì—ë§Œ í˜¸ì¶œë˜ë„ë¡ ì„¤ê³„ë˜ì–´ì•¼ í•¨.
                // alert('ë¨¼ì € ë§ì„ ì´ë™í•´ì£¼ì„¸ìš”!'); // ì´ ê²½ê³ ëŠ” í˜¸ì¶œí•˜ëŠ” ìª½ì—ì„œ ì²˜ë¦¬í•˜ëŠ”ê²Œ ë‚˜ì„ìˆ˜ë„
                return;
            }

            const currentPlayerObj = gameState.players[gameState.currentPlayer];
            if (currentPlayerObj.wallsRemaining <= 0) {
                alert('ë²½ì´ ëª¨ë‘ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤!');
                return;
            }

            // ë²½ ìœ íš¨ì„± ê²€ì‚¬ (ê²¹ì¹˜ëŠ”ì§€, ì¸ì ‘ ì…€ê³¼ ì¶©ëŒí•˜ëŠ”ì§€ ë“±)
            if (!isValidWallPlacement(row, col, direction)) {
                // isValidWallPlacement ë‚´ë¶€ì—ì„œ alertì„ í•˜ê±°ë‚˜, ì—¬ê¸°ì„œ í•´ë„ ë¨
                return;
            }
            
            // ë²½ ë°°ì¹˜
            gameState.walls[row][col][direction] = gameState.currentPlayer;
            // ì¸ì ‘ ì…€ì—ë„ ë²½ ì •ë³´ ê¸°ë¡ (ë²½ì€ ë‘ ì…€ì— ê±¸ì³ ìˆìŒ)
            if (direction === 'top' && row > 0) gameState.walls[row-1][col].bottom = gameState.currentPlayer;
            else if (direction === 'bottom' && row < BOARD_SIZE - 1) gameState.walls[row+1][col].top = gameState.currentPlayer;
            else if (direction === 'left' && col > 0) gameState.walls[row][col-1].right = gameState.currentPlayer;
            else if (direction === 'right' && col < BOARD_SIZE - 1) gameState.walls[row][col+1].left = gameState.currentPlayer;
            
            currentPlayerObj.wallsRemaining--;
            console.log(`${currentPlayerObj.name} í”Œë ˆì´ì–´ (${row},${col}) ${direction}ì— ë²½ ì„¤ì¹˜. ë‚¨ì€ ë²½: ${currentPlayerObj.wallsRemaining}`);

            updateBoard(); // ë³´ë“œ UI ì—…ë°ì´íŠ¸ (ë²½ í‘œì‹œ)
            endTurn(); // ë²½ ë°°ì¹˜ í›„ í„´ ì¢…ë£Œ
        }

        function isValidWallPlacement(row, col, direction) {
            // 1. í•´ë‹¹ ìœ„ì¹˜ì— ì´ë¯¸ ê°™ì€ ë°©í–¥ ë²½ì´ ìˆëŠ”ì§€ í™•ì¸
            if (gameState.walls[row][col][direction] !== null) {
                alert('ì´ë¯¸ ê°™ì€ ë°©í–¥ì— ë²½ì´ ìˆìŠµë‹ˆë‹¤!');
                return false;
            }

            // 2. êµì°¨í•˜ëŠ” ë²½ í™•ì¸ (ì˜ˆ: ê°€ë¡œë²½ ë†“ëŠ”ë° ì„¸ë¡œë²½ì´ ì´ë¯¸ í•´ë‹¹ ì…€ ëª¨ì„œë¦¬ë¥¼ ê³µìœ í•˜ë©° êµì°¨í•˜ëŠ”ì§€)
            // Quoridor ê·œì¹™ì—ì„œëŠ” ë²½ì€ í•­ìƒ ë‘ ì¹¸ì— ê±¸ì³ì„œ ì„¤ì¹˜ë˜ë©°, ë‹¤ë¥¸ ë²½ê³¼ êµì°¨í•  ìˆ˜ ì—†ìŒ.
            // í˜„ì¬ ë²½ ëª¨ë¸ì€ ì…€ì˜ ê° ë³€ì— ë²½ì„ ë‘ëŠ” ë°©ì‹.
            // ì¢€ ë” ë‹¨ìˆœí™”ëœ ëª¨ë¸ì—ì„œëŠ”, í•œ ì…€ì˜ top/bottom ë²½ê³¼ left/right ë²½ì´ ë™ì‹œì— í™œì„±í™”ë˜ëŠ” ê²ƒì€ êµì°¨ë¡œ ê°„ì£¼í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ.
            // ì—¬ê¸°ì„œëŠ” ë” ë³µì¡í•œ êµì°¨ ê²€ì‚¬ëŠ” ìƒëµ. (í•„ìš”ì‹œ ì¶”ê°€)

            // 3. ì¸ì ‘ ì…€ì— ëŒ€ì‘í•˜ëŠ” ë²½ì´ ì´ë¯¸ ìˆëŠ”ì§€ (ë‹¤ë¥¸ í”Œë ˆì´ì–´ì— ì˜í•´)
            // (ì´ ê²€ì‚¬ëŠ” placeWallInDirectionì—ì„œ ì´ë¯¸ ê°±ì‹ í•˜ë¯€ë¡œ ì‚¬ì‹¤ìƒ ì¤‘ë³µì¼ ìˆ˜ ìˆìœ¼ë‚˜, ë°©ì–´ì ìœ¼ë¡œ ì¶”ê°€)
            if (direction === 'top' && row > 0 && gameState.walls[row-1][col].bottom !== null) {
                alert('ì¸ì ‘í•œ ê³³ì— ì´ë¯¸ ë²½ì´ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤ (ìƒë‹¨).'); return false;
            }
            if (direction === 'bottom' && row < BOARD_SIZE - 1 && gameState.walls[row+1][col].top !== null) {
                alert('ì¸ì ‘í•œ ê³³ì— ì´ë¯¸ ë²½ì´ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤ (í•˜ë‹¨).'); return false;
            }
            if (direction === 'left' && col > 0 && gameState.walls[row][col-1].right !== null) {
                alert('ì¸ì ‘í•œ ê³³ì— ì´ë¯¸ ë²½ì´ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤ (ì¢Œì¸¡).'); return false;
            }
            if (direction === 'right' && col < BOARD_SIZE - 1 && gameState.walls[row][col+1].left !== null) {
                alert('ì¸ì ‘í•œ ê³³ì— ì´ë¯¸ ë²½ì´ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤ (ìš°ì¸¡).'); return false;
            }
            
            // 4. (ì¤‘ìš”) ë²½ì„ ë†“ì•˜ì„ ë•Œ ëª¨ë“  í”Œë ˆì´ì–´ê°€ ìì‹ ì˜ ëª©í‘œ ì§€ì ì— ë„ë‹¬í•  ìˆ˜ ì—†ëŠ” ê²½ìš°ê°€ ë°œìƒí•˜ëŠ”ì§€ í™•ì¸ (Quoridor ê·œì¹™)
            // ì´ ê²€ì‚¬ëŠ” BFS/DFS ë“±ìœ¼ë¡œ ê²½ë¡œ íƒìƒ‰ì´ í•„ìš”í•˜ì—¬ ë³µì¡í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ìƒëµ.
            // alert("ê²½ë¡œ ì°¨ë‹¨ ê²€ì‚¬ëŠ” ë¯¸êµ¬í˜„ ìƒíƒœì…ë‹ˆë‹¤.");

            return true;
        }


        // ê·œì¹™ ë³´ê¸°
        window.showRules = function() {
            alert(`
ğŸ§± Wall Go ê²Œì„ ê·œì¹™ (v0.2 - ê¸°ë³¸ ê·œì¹™)

ğŸ“‹ ê²Œì„ ê°œìš”:
- 2-${PLAYER_COLORS.length}ëª…ì´ ${BOARD_SIZE}x${BOARD_SIZE} ê²©ìì—ì„œ ê²½ìŸí•˜ëŠ” ì „ëµ ê²Œì„.
- ê° í”Œë ˆì´ì–´ëŠ” 2ê°œì˜ ë§ê³¼ ${INITIAL_WALLS_PER_PLAYER}ê°œì˜ ë²½ì„ ê°€ì§‘ë‹ˆë‹¤. (ë²½ ê°œìˆ˜ëŠ” ì„¤ì •ì— ë”°ë¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)

ğŸ¯ ê²Œì„ ì§„í–‰:
Phase 1: ì²« ë²ˆì§¸ ë§ ë°°ì¹˜ (í”Œë ˆì´ì–´ ìˆœì„œëŒ€ë¡œ)
Phase 2: ë‘ ë²ˆì§¸ ë§ ë°°ì¹˜ (Phase 1ì˜ ì—­ìˆœìœ¼ë¡œ)
Phase 3: ê²Œì„ í”Œë ˆì´

â±ï¸ í„´ ì œí•œì‹œê°„: ${INITIAL_TIME_LEFT}ì´ˆ

ğŸš¶ ë§ ì´ë™:
- ìì‹ ì˜ í„´ì— ìì‹ ì˜ ë§ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì—¬ ì´ë™.
- ìƒí•˜ì¢Œìš°ë¡œ 1ì¹¸ ë˜ëŠ” 2ì¹¸ ì´ë™ ê°€ëŠ¥.
- ë‹¤ë¥¸ ë§ì´ ìˆëŠ” ê³³ì´ë‚˜ ë²½ìœ¼ë¡œ ë§‰íŒ ê³³ìœ¼ë¡œëŠ” ì´ë™ ë¶ˆê°€.
- 2ì¹¸ ì´ë™ ì‹œ, ì¤‘ê°„ ì¹¸ì€ ë¹„ì–´ìˆì–´ì•¼ í•˜ê³  ë²½ìœ¼ë¡œ ë§‰í˜€ìˆì§€ ì•Šì•„ì•¼ í•¨.

ğŸ§± ë²½ ë°°ì¹˜:
- ë§ì„ ì´ë™í•œ í›„, í•´ë‹¹ í„´ì— ë²½ 1ê°œë¥¼ ì„¤ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- ë²½ì€ ì´ë™í•œ ë§ì´ ìˆëŠ” ì…€ì˜ ê°€ì¥ìë¦¬(ìƒ, í•˜, ì¢Œ, ìš° ì¤‘ í•˜ë‚˜)ì— ì„¤ì¹˜í•©ë‹ˆë‹¤.
- ë²½ì€ í„°ì¹˜ í›„ ìŠ¤ì™€ì´í”„í•˜ì—¬ ë°©í–¥ì„ ì§€ì •í•´ ì„¤ì¹˜í•©ë‹ˆë‹¤.
- ì´ë¯¸ ë²½ì´ ìˆëŠ” ê³³ì´ë‚˜, ê·œì¹™ì— ì–´ê¸‹ë‚˜ëŠ” ê³³(ì˜ˆ: ë‹¤ë¥¸ ë²½ê³¼ ì™„ì „íˆ ê²¹ì¹¨)ì—ëŠ” ì„¤ì¹˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
- (ì£¼ì˜: ëª¨ë“  í”Œë ˆì´ì–´ì˜ ë§ì´ ëª©í‘œì§€ì ì— ë„ë‹¬í•  ìˆ˜ ì—†ë„ë¡ ì™„ì „íˆ ê°€ë‘ëŠ” ë²½ ë°°ì¹˜ëŠ” ê¸ˆì§€ë˜ë‚˜, í˜„ì¬ ì´ ê²€ì‚¬ ë¡œì§ì€ ë¯¸êµ¬í˜„ ìƒíƒœì…ë‹ˆë‹¤.)

ğŸ”¨ ë²½ ë¶€ìˆ˜ê¸°:
- ìì‹ ì˜ í„´ ì‹œì‘ ì‹œ, ë§ ì´ë™ ì „ì— ì‚¬ìš© ê°€ëŠ¥.
- ê²Œì„ë‹¹ ë‹¨ 1íšŒë§Œ ì‚¬ìš© ê°€ëŠ¥.
- ì‚¬ìš© ì‹œ, ê¸°ì¡´ì— ì„¤ì¹˜ëœ ë²½ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì—¬ ì œê±°í•©ë‹ˆë‹¤. (í˜„ì¬ëŠ” ì„ íƒí•œ ì¹¸ ì£¼ë³€ì˜ ì„ì˜ ë²½ ì œê±°)
- ë²½ ë¶€ìˆ˜ê¸°ë¥¼ ì‚¬ìš©í•˜ë©´ í•´ë‹¹ í„´ì˜ í–‰ë™(ë§ ì´ë™, ë²½ ì„¤ì¹˜)ì€ í•  ìˆ˜ ì—†ê³  ì¦‰ì‹œ í„´ì´ ì¢…ë£Œë©ë‹ˆë‹¤.

ğŸ† ìŠ¹ë¦¬ ì¡°ê±´ (ë¯¸êµ¬í˜„):
- (ì˜ˆì‹œ) ìƒëŒ€ë°©ì˜ ë‘ ë§ì„ ëª¨ë‘ ìì‹ ì˜ ë²½ìœ¼ë¡œ ì™„ì „íˆ ê³ ë¦½ì‹œí‚¤ëŠ” í”Œë ˆì´ì–´ê°€ ìŠ¹ë¦¬.
- (ì˜ˆì‹œ) íŠ¹ì • ì ë ¹ ì§€ì—­ì„ í™•ë³´í•˜ê±°ë‚˜ ì ìˆ˜ë¥¼ ì–»ëŠ” ë°©ì‹.
- í˜„ì¬ ê²Œì„ ì¢…ë£Œ ë° ìŠ¹ë¦¬ ì¡°ê±´ì€ êµ¬í˜„ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. 'ìƒˆ ê²Œì„'ìœ¼ë¡œ ë¦¬ì…‹í•˜ì—¬ í”Œë ˆì´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            `);
        }

        // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
        window.addEventListener('DOMContentLoaded', () => {
            console.log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ë° ê²Œì„ ì„¤ì • ì¤€ë¹„');
            // ê¸°ë³¸ìœ¼ë¡œ 2ëª… ì„ íƒëœ ìƒíƒœë¡œ ì„¤ì •
            const defaultPlayerCountButton = document.querySelector('.player-count-btn'); // ì²« ë²ˆì§¸ ë²„íŠ¼ (2ëª…)
            if (defaultPlayerCountButton) {
                 // selectPlayerCount(2, {target: defaultPlayerCountButton}); // event ëª¨ì˜ ê°ì²´ ì „ë‹¬
                 defaultPlayerCountButton.classList.add('selected'); // ì§ì ‘ í´ë˜ìŠ¤ ì¶”ê°€
                 gameState.playerCount = 2; // gameStateë„ ì´ˆê¸°í™”
            } else {
                gameState.playerCount = 2; // ë²„íŠ¼ ëª»ì°¾ìœ¼ë©´ ê¸°ë³¸ê°’
            }
            // ê²Œì„ ì‹œì‘ ì „ì´ë¯€ë¡œ gameAreaì˜ UIëŠ” ì•„ì§ ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ
        });

    })(); // IIFE ë
    </script>
</body>
</html>
